<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÅ Minha C√°psula do Tempo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --natal-red: #c41e3a; --natal-green: #165b33; --natal-gold: #ffd700; --midnight: #0a0e14; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg, #0a0e14 0%, #1a2e1a 50%, #2a1a1a 100%); min-height: 100vh; color: white; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Pacifico', cursive; }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; top: -20px; color: rgba(255,255,255,0.8); animation: snowfall linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }

        .tela { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.5s ease; }
        .tela.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* TELA LACRADA */
        .tela-lacrada { align-items: center; text-align: center; padding: 30px 20px; }
        .foto-lacrada { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--natal-gold); overflow: hidden; margin-bottom: 16px; background: linear-gradient(135deg, var(--natal-red), var(--natal-green)); display: flex; align-items: center; justify-content: center; font-size: 4rem; box-shadow: 0 0 40px rgba(255,215,0,0.3); }
        .foto-lacrada img { width: 100%; height: 100%; object-fit: cover; }
        .nome-lacrada { font-size: 1.8rem; color: var(--natal-gold); margin-bottom: 4px; }
        .evento-lacrada { color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-bottom: 24px; }

        .capsula-3d { position: relative; width: 180px; height: 220px; margin: 20px auto; }
        .capsula-corpo { position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #ffd700 0%, #ffaa00 50%, #cc8800 100%); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; box-shadow: inset -20px -20px 40px rgba(0,0,0,0.3), 0 20px 40px rgba(0,0,0,0.4); animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .capsula-tampa { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 120px; height: 50px; background: linear-gradient(135deg, #ffcc00, #ff9900); border-radius: 50% 50% 0 0; }
        .capsula-lacre { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; z-index: 2; }
        .capsula-brilho { position: absolute; top: 20%; left: 20%; width: 30px; height: 30px; background: rgba(255,255,255,0.6); border-radius: 50%; filter: blur(5px); }

        .status-badge { padding: 12px 24px; border-radius: 20px; font-weight: 600; margin: 20px 0; }
        .status-lacrada { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
        .status-liberada { background: rgba(255,215,0,0.2); color: var(--natal-gold); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .countdown { display: flex; justify-content: center; gap: 12px; margin: 24px 0; }
        .countdown-item { text-align: center; }
        .countdown-value { font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 900; color: var(--natal-gold); background: rgba(0,0,0,0.3); padding: 12px 16px; border-radius: 12px; min-width: 60px; }
        .countdown-label { font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 4px; }

        .btn-abrir { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 18px 48px; border-radius: 16px; font-size: 1.2rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; box-shadow: 0 8px 30px rgba(255,215,0,0.4); transition: all 0.3s; margin-top: 20px; }
        .btn-abrir:hover { transform: translateY(-3px) scale(1.02); }
        .btn-abrir:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .msg-aguarde { color: rgba(255,255,255,0.5); font-size: 0.9rem; margin-top: 16px; }

        /* TELA ABERTA */
        .tela-aberta { padding: 20px 0; }
        .header-aberta { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .foto-mini { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 3px solid var(--natal-gold); flex-shrink: 0; }
        .foto-mini img { width: 100%; height: 100%; object-fit: cover; }
        .info-header h2 { font-size: 1.4rem; color: var(--natal-gold); }
        .info-header p { font-size: 0.85rem; color: rgba(255,255,255,0.6); }

        .secao { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .secao-titulo { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: var(--natal-gold); margin-bottom: 12px; font-weight: 600; }
        .secao-conteudo { color: rgba(255,255,255,0.9); line-height: 1.6; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-item { background: rgba(255,215,0,0.15); color: var(--natal-gold); padding: 6px 14px; border-radius: 15px; font-size: 0.85rem; }

        /* √ÅUDIO */
        .audio-player { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px; }
        .audio-player audio { width: 100%; }
        .audio-info { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .audio-icon { font-size: 2rem; }
        .audio-text { color: rgba(255,255,255,0.7); font-size: 0.9rem; }

        /* PERGUNTAS */
        .pergunta-item { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 14px; margin-bottom: 12px; border-left: 3px solid var(--natal-gold); }
        .pergunta-label { font-size: 0.8rem; color: var(--natal-gold); margin-bottom: 6px; }
        .pergunta-resposta { color: white; }
        .felicidade-display { display: flex; align-items: center; gap: 8px; }
        .felicidade-nota { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--natal-gold); }
        .felicidade-barra { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .felicidade-fill { height: 100%; background: var(--natal-gold); border-radius: 4px; }

        /* MENSAGEM */
        .mensagem-texto { white-space: pre-wrap; font-size: 1rem; line-height: 1.7; }
        .mensagem-chars { text-align: right; font-size: 0.8rem; color: rgba(255,255,255,0.4); margin-top: 8px; }

        /* REFLEX√ÉO */
        .reflexao-form textarea { width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(255,255,255,0.08); color: white; font-size: 1rem; font-family: 'Poppins', sans-serif; resize: none; min-height: 100px; }
        .reflexao-form textarea:focus { outline: none; border-color: var(--natal-gold); }
        .btn-salvar { background: var(--natal-green); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 12px; font-family: 'Poppins', sans-serif; }
        .reflexao-salva { background: rgba(22,91,51,0.2); border-radius: 12px; padding: 16px; border-left: 3px solid var(--natal-green); }
        .reflexao-salva-titulo { color: var(--natal-green); font-size: 0.85rem; margin-bottom: 8px; }

        .btn-compartilhar { width: 100%; background: transparent; border: 2px solid var(--natal-gold); color: var(--natal-gold); padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 16px; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
        .btn-compartilhar:hover { background: var(--natal-gold); color: var(--midnight); }

        /* ANIMA√á√ÉO ABERTURA */
        .abertura-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.5s; }
        .abertura-overlay.active { opacity: 1; visibility: visible; }
        .abertura-capsula { font-size: 8rem; }
        .abertura-capsula.shake { animation: shakeOpen 0.5s ease; }
        @keyframes shakeOpen { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
        .abertura-capsula.explode { animation: explodeOpen 0.8s ease forwards; }
        @keyframes explodeOpen { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); } 100% { transform: scale(3); opacity: 0; } }
        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 1001; pointer-events: none; }
        .flash.active { animation: flashAnim 0.8s ease; }
        @keyframes flashAnim { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* CONFETES */
        .confetes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
        .confete { position: absolute; animation: confeteFall 3s ease-out forwards; }
        @keyframes confeteFall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(720deg); } }

        /* TOAST */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--natal-green); color: white; padding: 14px 24px; border-radius: 12px; font-weight: 500; z-index: 3000; opacity: 0; transition: all 0.4s; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ERRO */
        .tela-erro { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .erro-icon { font-size: 5rem; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="confetes" id="confetes"></div>
    <div class="flash" id="flash"></div>

    <div class="container">
        <!-- TELA LACRADA -->
        <div class="tela tela-lacrada active" id="telaLacrada">
            <div class="foto-lacrada" id="fotoLacrada">üë§</div>
            <h1 class="nome-lacrada" id="nomeLacrada">Carregando...</h1>
            <p class="evento-lacrada" id="eventoLacrada">Evento</p>
            
            <div class="capsula-3d">
                <div class="capsula-corpo">
                    <div class="capsula-brilho"></div>
                </div>
                <div class="capsula-tampa"></div>
                <div class="capsula-lacre" id="capsulLacre">üîí</div>
            </div>
            
            <div class="status-badge status-lacrada" id="statusBadge">üîí C√°psula Lacrada</div>
            
            <div class="countdown" id="countdown">
                <div class="countdown-item">
                    <div class="countdown-value" id="dias">--</div>
                    <div class="countdown-label">DIAS</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="horas">--</div>
                    <div class="countdown-label">HORAS</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="minutos">--</div>
                    <div class="countdown-label">MIN</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="segundos">--</div>
                    <div class="countdown-label">SEG</div>
                </div>
            </div>
            
            <button class="btn-abrir" id="btnAbrir" onclick="iniciarAbertura()" disabled>üéÅ ABRIR C√ÅPSULA</button>
            <p class="msg-aguarde" id="msgAguarde">Aguardando libera√ß√£o do guardi√£o...</p>
        </div>

        <!-- TELA ABERTA -->
        <div class="tela tela-aberta" id="telaAberta">
            <div class="header-aberta">
                <div class="foto-mini" id="fotoAberta"></div>
                <div class="info-header">
                    <h2 id="nomeAberta">Nome</h2>
                    <p id="dataAberta">Criada em --/--/----</p>
                    <p id="eventoAberta">Evento</p>
                </div>
            </div>
            
            <div class="secao" id="secaoDesejos">
                <div class="secao-titulo">üåü Desejos para o futuro</div>
                <div class="tags-container" id="desejosContainer"></div>
            </div>
            
            <div class="secao" id="secaoPessoas" style="display:none">
                <div class="secao-titulo">üë• Pessoas importantes</div>
                <div class="tags-container" id="pessoasContainer"></div>
            </div>
            
            <div class="secao" id="secaoAudio" style="display:none">
                <div class="secao-titulo">üé§ Mensagem de voz</div>
                <div class="audio-player">
                    <div class="audio-info">
                        <span class="audio-icon">üéôÔ∏è</span>
                        <span class="audio-text">Ou√ßa a mensagem que voc√™ gravou</span>
                    </div>
                    <audio id="audioPlayer" controls></audio>
                </div>
            </div>
            
            <div class="secao" id="secaoPerguntas" style="display:none">
                <div class="secao-titulo">üí≠ Reflex√µes do passado</div>
                <div id="perguntasContainer"></div>
            </div>
            
            <div class="secao">
                <div class="secao-titulo">üíå Mensagem para o futuro</div>
                <div class="secao-conteudo">
                    <div class="mensagem-texto" id="mensagemTexto"></div>
                    <div class="mensagem-chars" id="mensagemChars"></div>
                </div>
            </div>
            
            <div class="secao" id="secaoReflexao">
                <div class="secao-titulo">‚úçÔ∏è Sua reflex√£o agora</div>
                <div class="reflexao-form" id="reflexaoForm">
                    <textarea id="reflexaoInput" placeholder="O que voc√™ sente ao ler isso? Suas previs√µes se realizaram? O que mudou?"></textarea>
                    <button class="btn-salvar" onclick="salvarReflexao()">üíæ Salvar reflex√£o</button>
                </div>
                <div class="reflexao-salva" id="reflexaoSalva" style="display:none">
                    <div class="reflexao-salva-titulo">üìù Sua reflex√£o:</div>
                    <div id="reflexaoTexto"></div>
                </div>
            </div>
            
            <button class="btn-compartilhar" onclick="compartilhar()">üì§ Compartilhar minha c√°psula</button>
        </div>

        <!-- TELA ERRO -->
        <div class="tela tela-erro" id="telaErro">
            <div class="erro-icon">üòï</div>
            <h2 style="color:var(--natal-gold);margin-bottom:12px">C√°psula n√£o encontrada</h2>
            <p style="color:rgba(255,255,255,0.6)">Verifique o link e tente novamente</p>
        </div>
    </div>

    <!-- ANIMA√á√ÉO ABERTURA -->
    <div class="abertura-overlay" id="aberturaOverlay">
        <div class="abertura-capsula" id="aberturaCapsula">üéÅ</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB2cNiBL1SU_QfjH_S_QGv_KSiFoocfqd4",
            authDomain: "capsuladotempo-f86bf.firebaseapp.com",
            databaseURL: "https://capsuladotempo-f86bf-default-rtdb.firebaseio.com",
            projectId: "capsuladotempo-f86bf",
            storageBucket: "capsuladotempo-f86bf.firebasestorage.app",
            messagingSenderId: "43014678980",
            appId: "1:43014678980:web:0c84f48037ee6924afdc91"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==========================================
        // VARI√ÅVEIS
        // ==========================================
        let capsulaId = null;
        let capsulaData = null;
        let eventoData = null;
        let isGuardiao = false;
        let countdownInterval = null;

        // ==========================================
        // UTILS
        // ==========================================
        const formatarData = (d) => new Date(d).toLocaleDateString('pt-BR');
        
        const mostrarToast = (msg) => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show';
            setTimeout(() => t.className = 'toast', 3000);
        };

        function criarParticulas() {
            const c = document.getElementById('particles');
            ['‚ùÑ','‚ùÖ','‚ùÜ','‚úß'].forEach(f => {
                for(let i=0;i<6;i++) {
                    const e = document.createElement('div');
                    e.className = 'snowflake';
                    e.textContent = f;
                    e.style.left = Math.random()*100+'vw';
                    e.style.animationDuration = (8+Math.random()*5)+'s';
                    e.style.animationDelay = Math.random()*10+'s';
                    e.style.fontSize = (0.5+Math.random()*0.8)+'rem';
                    c.appendChild(e);
                }
            });
            for(let i=0;i<30;i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100+'vw';
                s.style.top = Math.random()*100+'vh';
                const sz = 1+Math.random()*2;
                s.style.width = sz+'px';
                s.style.height = sz+'px';
                s.style.animationDuration = (2+Math.random()*3)+'s';
                c.appendChild(s);
            }
        }

        function criarConfetes() {
            const c = document.getElementById('confetes');
            c.innerHTML = '';
            const cores = ['#c41e3a','#165b33','#ffd700','#fff','#ff6b6b','#4ecdc4'];
            for(let i=0;i<150;i++) {
                const cf = document.createElement('div');
                cf.className = 'confete';
                cf.style.left = Math.random()*100+'vw';
                cf.style.background = cores[Math.floor(Math.random()*cores.length)];
                cf.style.animationDelay = Math.random()*2+'s';
                const sz = 5+Math.random()*10;
                cf.style.width = sz+'px';
                cf.style.height = sz+'px';
                cf.style.borderRadius = Math.random()>0.5?'50%':'0';
                c.appendChild(cf);
            }
        }

        function mostrarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // ==========================================
        // CARREGAR C√ÅPSULA
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            criarParticulas();
            
            const params = new URLSearchParams(window.location.search);
            capsulaId = params.get('id');
            isGuardiao = params.get('guardiao') === 'true';
            
            if (!capsulaId) {
                mostrarTela('telaErro');
                return;
            }
            
            try {
                // Carregar c√°psula
                const capSnap = await database.ref(`capsulas/${capsulaId}`).once('value');
                capsulaData = capSnap.val();
                
                if (!capsulaData) {
                    mostrarTela('telaErro');
                    return;
                }
                
                // Carregar evento
                const evtSnap = await database.ref(`eventos/${capsulaData.eventoId}`).once('value');
                eventoData = evtSnap.val();
                
                // Se j√° foi aberta, mostrar conte√∫do
                if (capsulaData.aberta) {
                    mostrarConteudo();
                    return;
                }
                
                // Mostrar tela lacrada
                renderizarLacrada();
                
            } catch (err) {
                console.error(err);
                mostrarTela('telaErro');
            }
        });

        // ==========================================
        // TELA LACRADA
        // ==========================================
        function renderizarLacrada() {
            // Foto
            const fotoEl = document.getElementById('fotoLacrada');
            if (capsulaData.foto) {
                fotoEl.innerHTML = `<img src="${capsulaData.foto}">`;
            }
            
            // Nome
            document.getElementById('nomeLacrada').textContent = `${capsulaData.nome} ${capsulaData.sobrenome}`;
            document.getElementById('eventoLacrada').textContent = eventoData?.nome || 'C√°psula do Tempo';
            
            // Status
            const statusEl = document.getElementById('statusBadge');
            const btnAbrir = document.getElementById('btnAbrir');
            const msgAguarde = document.getElementById('msgAguarde');
            const lacreEl = document.getElementById('capsulLacre');
            
            if (capsulaData.liberada || isGuardiao) {
                statusEl.className = 'status-badge status-liberada';
                statusEl.textContent = 'üîì Liberada para abertura!';
                lacreEl.textContent = 'üîì';
                btnAbrir.disabled = false;
                msgAguarde.style.display = 'none';
            } else {
                statusEl.className = 'status-badge status-lacrada';
                statusEl.textContent = 'üîí C√°psula Lacrada';
                lacreEl.textContent = 'üîí';
                btnAbrir.disabled = true;
                msgAguarde.style.display = 'block';
            }
            
            // Countdown
            atualizarCountdown();
            countdownInterval = setInterval(atualizarCountdown, 1000);
        }

        function atualizarCountdown() {
            const abertura = new Date(capsulaData.dataAbertura);
            const agora = new Date();
            const diff = abertura - agora;
            
            if (diff <= 0) {
                document.getElementById('dias').textContent = '0';
                document.getElementById('horas').textContent = '0';
                document.getElementById('minutos').textContent = '0';
                document.getElementById('segundos').textContent = '0';
                return;
            }
            
            const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const min = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seg = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('dias').textContent = dias;
            document.getElementById('horas').textContent = horas.toString().padStart(2, '0');
            document.getElementById('minutos').textContent = min.toString().padStart(2, '0');
            document.getElementById('segundos').textContent = seg.toString().padStart(2, '0');
        }

        // ==========================================
        // ANIMA√á√ÉO DE ABERTURA
        // ==========================================
        async function iniciarAbertura() {
            const overlay = document.getElementById('aberturaOverlay');
            const capsula = document.getElementById('aberturaCapsula');
            const flash = document.getElementById('flash');
            
            overlay.classList.add('active');
            
            // Shake 1
            await new Promise(r => setTimeout(r, 500));
            capsula.classList.add('shake');
            await new Promise(r => setTimeout(r, 500));
            capsula.classList.remove('shake');
            
            // Shake 2
            await new Promise(r => setTimeout(r, 300));
            capsula.classList.add('shake');
            await new Promise(r => setTimeout(r, 500));
            capsula.classList.remove('shake');
            
            // Shake 3 + Explode
            await new Promise(r => setTimeout(r, 200));
            capsula.classList.add('shake');
            await new Promise(r => setTimeout(r, 300));
            capsula.classList.remove('shake');
            capsula.classList.add('explode');
            
            // Flash
            await new Promise(r => setTimeout(r, 400));
            flash.classList.add('active');
            
            // Salvar como aberta
            await database.ref(`capsulas/${capsulaId}`).update({
                aberta: true,
                dataVisualizacao: new Date().toISOString()
            });
            
            // Mostrar conte√∫do
            await new Promise(r => setTimeout(r, 800));
            flash.classList.remove('active');
            overlay.classList.remove('active');
            capsula.classList.remove('explode');
            
            clearInterval(countdownInterval);
            mostrarConteudo();
            criarConfetes();
        }

        // ==========================================
        // MOSTRAR CONTE√öDO
        // ==========================================
        function mostrarConteudo() {
            // Header
            const fotoAberta = document.getElementById('fotoAberta');
            if (capsulaData.foto) {
                fotoAberta.innerHTML = `<img src="${capsulaData.foto}">`;
            } else {
                fotoAberta.innerHTML = '<div style="width:100%;height:100%;background:linear-gradient(135deg,#c41e3a,#165b33);display:flex;align-items:center;justify-content:center;font-size:2rem">üë§</div>';
            }
            
            document.getElementById('nomeAberta').textContent = `${capsulaData.nome} ${capsulaData.sobrenome}`;
            document.getElementById('dataAberta').textContent = `Criada em ${formatarData(capsulaData.dataCriacao)}`;
            document.getElementById('eventoAberta').textContent = eventoData?.nome || '';
            
            // Desejos
            const desejosContainer = document.getElementById('desejosContainer');
            if (capsulaData.desejos && capsulaData.desejos.length > 0) {
                desejosContainer.innerHTML = capsulaData.desejos.map(d => `<span class="tag-item">${d}</span>`).join('');
            }
            
            // Pessoas
            if (capsulaData.pessoas && capsulaData.pessoas.length > 0) {
                document.getElementById('secaoPessoas').style.display = 'block';
                document.getElementById('pessoasContainer').innerHTML = capsulaData.pessoas.map(p => `<span class="tag-item">${p}</span>`).join('');
            }
            
            // √Åudio
            if (capsulaData.audio) {
                document.getElementById('secaoAudio').style.display = 'block';
                document.getElementById('audioPlayer').src = capsulaData.audio;
            }
            
            // Perguntas
            if (capsulaData.perguntas) {
                const p = capsulaData.perguntas;
                let html = '';
                
                if (p.conquista) {
                    html += `<div class="pergunta-item"><div class="pergunta-label">üéØ O que achava que ia conquistar:</div><div class="pergunta-resposta">${p.conquista}</div></div>`;
                }
                if (p.momento) {
                    html += `<div class="pergunta-item"><div class="pergunta-label">‚ú® Momento marcante daquele ano:</div><div class="pergunta-resposta">${p.momento}</div></div>`;
                }
                if (p.palavra) {
                    html += `<div class="pergunta-item"><div class="pergunta-label">üìù Palavra que definia o momento:</div><div class="pergunta-resposta" style="font-size:1.3rem;color:var(--natal-gold)">${p.palavra}</div></div>`;
                }
                if (p.felicidade) {
                    html += `<div class="pergunta-item"><div class="pergunta-label">üòä Felicidade naquela √©poca:</div><div class="felicidade-display"><span class="felicidade-nota">${p.felicidade}</span><div class="felicidade-barra"><div class="felicidade-fill" style="width:${p.felicidade*10}%"></div></div></div></div>`;
                }
                if (p.previsao) {
                    html += `<div class="pergunta-item"><div class="pergunta-label">üîÆ Previs√£o para o futuro:</div><div class="pergunta-resposta">"${p.previsao}"</div></div>`;
                }
                
                if (html) {
                    document.getElementById('secaoPerguntas').style.display = 'block';
                    document.getElementById('perguntasContainer').innerHTML = html;
                }
            }
            
            // Mensagem
            document.getElementById('mensagemTexto').textContent = capsulaData.mensagemPessoal || '(Sem mensagem)';
            document.getElementById('mensagemChars').textContent = `${(capsulaData.mensagemPessoal || '').length} caracteres`;
            
            // Reflex√£o
            if (capsulaData.reflexao) {
                document.getElementById('reflexaoForm').style.display = 'none';
                document.getElementById('reflexaoSalva').style.display = 'block';
                document.getElementById('reflexaoTexto').textContent = capsulaData.reflexao;
            }
            
            mostrarTela('telaAberta');
        }

        // ==========================================
        // REFLEX√ÉO
        // ==========================================
        async function salvarReflexao() {
            const texto = document.getElementById('reflexaoInput').value.trim();
            if (!texto) {
                mostrarToast('Escreva sua reflex√£o');
                return;
            }
            
            await database.ref(`capsulas/${capsulaId}/reflexao`).set(texto);
            
            document.getElementById('reflexaoForm').style.display = 'none';
            document.getElementById('reflexaoSalva').style.display = 'block';
            document.getElementById('reflexaoTexto').textContent = texto;
            
            mostrarToast('‚úì Reflex√£o salva!');
        }

        // ==========================================
        // COMPARTILHAR
        // ==========================================
        function compartilhar() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: `üéÅ C√°psula de ${capsulaData.nome}`,
                    text: 'Veja minha c√°psula do tempo!',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url);
                mostrarToast('‚úì Link copiado!');
            }
        }
    </script>
</body>
</html>
