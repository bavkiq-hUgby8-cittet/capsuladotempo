<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚è≥ C√°psula do Tempo - Painel do Guardi√£o</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #0c0f14;
            --bg-card: rgba(255,255,255,0.03);
            --bg-card-hover: rgba(255,255,255,0.06);
            --gold-primary: #d4af37;
            --gold-light: #f4d03f;
            --gold-dark: #b8962e;
            --accent-warm: #e67e22;
            --accent-success: #27ae60;
            --accent-danger: #c0392b;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.7);
            --text-muted: rgba(255,255,255,0.4);
            --border-subtle: rgba(255,255,255,0.08);
            --border-gold: rgba(212,175,55,0.3);
            --shadow-gold: 0 0 60px rgba(212,175,55,0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4 { 
            font-family: 'Playfair Display', Georgia, serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .atmosphere {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        
        .atmosphere::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(212,175,55,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(230,126,34,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(212,175,55,0.03) 0%, transparent 70%);
            animation: atmosphereMove 30s ease-in-out infinite;
        }
        
        @keyframes atmosphereMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2%, 2%) rotate(1deg); }
            66% { transform: translate(-1%, 1%) rotate(-1deg); }
        }
        
        .star {
            position: absolute;
            background: var(--gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: starTwinkle 4s ease-in-out infinite;
        }
        
        @keyframes starTwinkle {
            0%, 100% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 0.8; transform: scale(1); }
        }

        .auth-screen {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg-deep);
        }
        
        .auth-screen.hidden { display: none; }
        
        .auth-container {
            width: 100%;
            max-width: 420px;
            animation: authFadeIn 0.8s ease;
        }
        
        @keyframes authFadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .auth-logo {
            font-size: 4rem;
            margin-bottom: 16px;
            display: inline-block;
            animation: logoFloat 4s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        
        .auth-title {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--gold-light), var(--gold-primary), var(--accent-warm));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .auth-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 36px;
            backdrop-filter: blur(20px);
        }
        
        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 28px;
            background: rgba(0,0,0,0.3);
            padding: 6px;
            border-radius: var(--radius-md);
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            background: var(--gold-primary);
            color: var(--bg-deep);
        }
        
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        
        .form-field {
            margin-bottom: 20px;
        }
        
        .form-field label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-field input {
            width: 100%;
            padding: 16px 18px;
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-field input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 4px rgba(212,175,55,0.1);
        }
        
        .form-field input::placeholder {
            color: var(--text-muted);
        }
        
        .auth-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-deep);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212,175,55,0.3);
        }
        
        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-error {
            background: rgba(192,57,43,0.2);
            border: 2px solid rgba(231,76,60,0.5);
            color: #ff6b6b;
            padding: 14px 18px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: 16px;
            display: none;
            text-align: center;
        }
        
        .auth-error.show { display: block; animation: shake 0.5s ease; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .auth-status {
            text-align: center;
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .auth-status.checking {
            background: rgba(241,196,15,0.15);
            color: #f1c40f;
        }
        
        .auth-status.ok {
            background: rgba(39,174,96,0.15);
            color: #2ecc71;
        }
        
        .auth-status.error {
            background: rgba(231,76,60,0.15);
            color: #e74c3c;
        }

        .app { display: none; }
        .app.active { display: block; }
        
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(12,15,20,0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 16px 24px;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .brand-icon { font-size: 1.8rem; }
        
        .brand-text h1 {
            font-size: 1.4rem;
            color: var(--gold-primary);
        }
        
        .brand-text span {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold-primary), var(--accent-warm));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--bg-deep);
            font-size: 0.85rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .btn-icon:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
            position: relative;
            z-index: 1;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .section-title {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-title span {
            font-size: 1.6rem;
        }
        
        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-deep);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.25);
        }
        
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-gold);
            color: var(--text-primary);
        }

        .create-section {
            background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(230,126,34,0.05));
            border: 1px solid var(--border-gold);
            border-radius: var(--radius-xl);
            padding: 32px;
            margin-bottom: 40px;
        }
        
        .create-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
        }
        
        .create-form .form-field {
            margin-bottom: 0;
        }
        
        .create-form .form-field input {
            background: rgba(0,0,0,0.3);
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
        }
        
        .event-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all 0.4s;
        }
        
        .event-card:hover {
            border-color: var(--border-gold);
            transform: translateY(-4px);
            box-shadow: var(--shadow-gold);
        }
        
        .event-card.archived {
            opacity: 0.6;
        }
        
        .event-header {
            padding: 24px;
            background: linear-gradient(135deg, rgba(212,175,55,0.1), transparent);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .event-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        
        .event-status.active {
            background: rgba(39,174,96,0.15);
            color: #2ecc71;
        }
        
        .event-status.archived {
            background: rgba(255,255,255,0.1);
            color: var(--text-muted);
        }
        
        .event-name {
            font-size: 1.4rem;
            margin-bottom: 8px;
            color: var(--gold-light);
        }
        
        .event-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .event-body {
            padding: 24px;
        }
        
        .event-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 600;
            color: var(--gold-primary);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }
        
        .event-participants {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--bg-deep);
            overflow: hidden;
            background: linear-gradient(135deg, var(--gold-primary), var(--accent-warm));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin-left: -12px;
        }
        
        .participant-avatar:first-child { margin-left: 0; }
        .participant-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .participant-more {
            background: var(--bg-card-hover);
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .event-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .event-btn {
            padding: 12px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .event-btn.qr {
            background: var(--gold-primary);
            border: none;
            color: var(--bg-deep);
        }
        
        .event-btn.manage {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        
        .event-btn.manage:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        
        .event-btn.archive {
            background: rgba(192,57,43,0.1);
            border: 1px solid rgba(192,57,43,0.3);
            color: #e74c3c;
            grid-column: span 2;
        }
        
        .event-btn.open {
            background: linear-gradient(135deg, var(--accent-success), #219a52);
            border: none;
            color: white;
            grid-column: span 2;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }
        
        .empty-icon {
            font-size: 5rem;
            margin-bottom: 24px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.4rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .empty-text {
            font-size: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: #1a1d24;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: all 0.3s;
        }
        
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(192,57,43,0.2);
            color: #e74c3c;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .qr-display {
            text-align: center;
            padding: 20px;
        }
        
        .qr-container {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .qr-link {
            background: rgba(0,0,0,0.3);
            padding: 14px 18px;
            border-radius: var(--radius-md);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-break: break-all;
            margin-bottom: 16px;
        }
        
        .qr-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .capsule-manager {
            padding: 24px;
        }
        
        .manager-header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .manager-title {
            font-size: 1.8rem;
            color: var(--gold-light);
            margin-bottom: 8px;
        }
        
        .manager-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 20px;
        }
        
        .manager-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        .capsules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .capsule-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .capsule-card:hover {
            border-color: var(--border-gold);
        }
        
        .capsule-card.released {
            border-color: var(--accent-success);
            background: rgba(39,174,96,0.05);
        }
        
        .capsule-card.opened {
            border-color: var(--gold-primary);
            background: rgba(212,175,55,0.05);
        }
        
        .capsule-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 14px;
            overflow: hidden;
            border: 3px solid var(--border-subtle);
            background: linear-gradient(135deg, var(--gold-primary), var(--accent-warm));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .capsule-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .capsule-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }
        
        .capsule-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .capsule-status.released { color: var(--accent-success); }
        .capsule-status.opened { color: var(--gold-primary); }
        
        .capsule-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 14px;
        }
        
        .capsule-tag {
            background: rgba(212,175,55,0.15);
            color: var(--gold-primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .capsule-btn {
            width: 100%;
            padding: 10px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .capsule-btn.release {
            background: var(--accent-success);
            border: none;
            color: white;
        }
        
        .capsule-btn.view {
            background: var(--gold-primary);
            border: none;
            color: var(--bg-deep);
        }

        .notification {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s;
        }
        
        .notification.active {
            opacity: 1;
            visibility: visible;
        }
        
        .notif-photo {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 5px solid var(--gold-primary);
            overflow: hidden;
            margin-bottom: 24px;
            animation: notifPop 0.6s ease;
            box-shadow: 0 0 60px rgba(212,175,55,0.4);
        }
        
        @keyframes notifPop {
            from { transform: scale(0) rotate(-20deg); }
            to { transform: scale(1) rotate(0); }
        }
        
        .notif-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .notif-name {
            font-size: 2.5rem;
            color: var(--gold-primary);
            margin-bottom: 12px;
            font-family: 'Playfair Display', serif;
        }
        
        .notif-action {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .notif-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 400px;
        }
        
        .notif-tag {
            background: rgba(212,175,55,0.2);
            color: var(--gold-light);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .confetti-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 2001;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }
        
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border-gold);
            padding: 16px 24px;
            border-radius: var(--radius-md);
            font-weight: 500;
            z-index: 3000;
            opacity: 0;
            transition: all 0.4s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            border-color: rgba(192,57,43,0.5);
            background: rgba(192,57,43,0.15);
        }

        @media (max-width: 768px) {
            .header-content { flex-wrap: wrap; }
            .user-info span { display: none; }
            .create-form { grid-template-columns: 1fr; }
            .events-grid { grid-template-columns: 1fr; }
            .section-header { flex-direction: column; align-items: stretch; }
            .section-title { font-size: 1.4rem; }
            .auth-card { padding: 24px; }
            .manager-stats { flex-wrap: wrap; gap: 20px; }
        }
    </style>
</head>
<body>
    <div class="atmosphere" id="atmosphere"></div>
    <div class="confetti-container" id="confetti"></div>

    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-logo">‚è≥</div>
                <h1 class="auth-title">C√°psula do Tempo</h1>
                <p class="auth-subtitle">Guarde mem√≥rias para o futuro</p>
            </div>
            
            <div class="auth-card">
                <div class="auth-status checking" id="authStatus">üîÑ Verificando conex√£o com Firebase...</div>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Entrar</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Criar Conta</button>
                </div>
                
                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-field">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                    </div>
                    <div class="form-field">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="auth-btn" id="loginBtn">Entrar</button>
                    <div class="auth-error" id="loginError"></div>
                </form>
                
                <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-field">
                        <label>Nome</label>
                        <input type="text" id="registerName" placeholder="Seu nome" required>
                    </div>
                    <div class="form-field">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="seu@email.com" required>
                    </div>
                    <div class="form-field">
                        <label>Senha</label>
                        <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres" minlength="6" required>
                    </div>
                    <button type="submit" class="auth-btn" id="registerBtn">Criar Conta</button>
                    <div class="auth-error" id="registerError"></div>
                </form>
            </div>
        </div>
    </div>

    <div class="app" id="app">
        <header class="header">
            <div class="header-content">
                <div class="brand">
                    <span class="brand-icon">‚è≥</span>
                    <div class="brand-text">
                        <h1>C√°psula do Tempo</h1>
                        <span>Painel do Guardi√£o</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">G</div>
                        <span id="userName">Guardi√£o</span>
                    </div>
                    <button class="btn-icon" onclick="openSearch()" title="Buscar c√°psula">üîç</button>
                    <button class="btn-icon" onclick="handleLogout()" title="Sair">üö™</button>
                </div>
            </div>
        </header>
        
        <main class="main">
            <section class="create-section">
                <form class="create-form" onsubmit="createEvent(event)">
                    <div class="form-field">
                        <label>Nome do Evento</label>
                        <input type="text" id="eventName" placeholder="Ex: Natal 2025" required>
                    </div>
                    <div class="form-field">
                        <label>Data de Abertura</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <button type="submit" class="btn-primary">
                        <span>‚ú®</span>
                        Criar Evento
                    </button>
                </form>
            </section>
            
            <section>
                <div class="section-header">
                    <h2 class="section-title"><span>üì¶</span> Seus Eventos</h2>
                </div>
                <div class="events-grid" id="eventsGrid">
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h3 class="empty-title">Nenhum evento ainda</h3>
                        <p class="empty-text">Crie seu primeiro evento para come√ßar a colecionar mem√≥rias!</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="qrModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><span>üì±</span> QR Code do Evento</h3>
                <button class="modal-close" onclick="closeModal('qrModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="qr-display">
                    <div class="qr-container" id="qrCode"></div>
                    <div class="qr-link" id="qrLink">Link aqui</div>
                    <div class="qr-actions">
                        <button class="btn-secondary" onclick="copyEventLink()">üìã Copiar Link</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="managerModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><span>üéâ</span> Gerenciar C√°psulas</h3>
                <button class="modal-close" onclick="closeModal('managerModal')">√ó</button>
            </div>
            <div class="modal-body capsule-manager" id="capsuleManager"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="searchModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><span>üîç</span> Buscar C√°psula</h3>
                <button class="modal-close" onclick="closeModal('searchModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Nome do participante</label>
                    <input type="text" id="searchInput" placeholder="Digite o nome..." oninput="searchCapsules()">
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="passwordModal">
        <div class="modal" style="max-width: 360px;">
            <div class="modal-header">
                <h3 class="modal-title"><span>üîê</span> Liberar C√°psula</h3>
                <button class="modal-close" onclick="closeModal('passwordModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Digite sua senha para confirmar:</p>
                <div class="form-field">
                    <input type="password" id="releasePassword" placeholder="Sua senha">
                </div>
                <button class="btn-primary" style="width: 100%;" onclick="confirmRelease()">üîì Liberar</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notif-photo" id="notifPhoto">üë§</div>
        <h2 class="notif-name" id="notifName">Nome</h2>
        <p class="notif-action" id="notifAction">‚ú® lacrou sua c√°psula!</p>
        <div class="notif-tags" id="notifTags"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2cNiBL1SU_QfjH_S_QGv_KSiFoocfqd4",
            authDomain: "capsuladotempo-f86bf.firebaseapp.com",
            databaseURL: "https://capsuladotempo-f86bf-default-rtdb.firebaseio.com",
            projectId: "capsuladotempo-f86bf",
            storageBucket: "capsuladotempo-f86bf.firebasestorage.app",
            messagingSenderId: "43014678980",
            appId: "1:43014678980:web:0c84f48037ee6924afdc91"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Verifica√ß√£o inicial
        console.log('üî• Firebase inicializado');
        console.log('üîê Auth dispon√≠vel:', !!auth);
        
        // Teste de conex√£o com Auth
        function checkAuthStatus() {
            const statusEl = document.getElementById('authStatus');
            
            auth.fetchSignInMethodsForEmail('teste@teste.com')
                .then(() => {
                    console.log('‚úÖ Firebase Auth est√° ATIVADO!');
                    statusEl.className = 'auth-status ok';
                    statusEl.innerHTML = '‚úÖ Firebase Auth conectado!';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                })
                .catch(err => {
                    if (err.code === 'auth/invalid-email' || err.code === 'auth/user-not-found') {
                        console.log('‚úÖ Firebase Auth est√° ATIVADO!');
                        statusEl.className = 'auth-status ok';
                        statusEl.innerHTML = '‚úÖ Firebase Auth conectado!';
                        setTimeout(() => statusEl.style.display = 'none', 3000);
                    } else if (err.code === 'auth/operation-not-allowed' || err.code === 'auth/configuration-not-found') {
                        console.error('‚ùå Firebase Auth N√ÉO est√° ativado!');
                        statusEl.className = 'auth-status error';
                        statusEl.innerHTML = '‚ùå ERRO: Firebase Auth n√£o est√° ativado!<br><small>V√° no Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Ative Email/Password</small>';
                    } else {
                        console.log('üîç Status:', err.code);
                        statusEl.className = 'auth-status ok';
                        statusEl.innerHTML = '‚úÖ Conectado';
                        setTimeout(() => statusEl.style.display = 'none', 3000);
                    }
                });
        }
        
        // Executar ap√≥s DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            createAtmosphere();
            checkAuthStatus();
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                }
            });
            
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.classList.remove('active');
                });
            });
        });

        let currentUser = null;
        let eventsData = {};
        let capsulesData = {};
        let previousCapsules = {};
        let firstLoad = true;
        let currentEventLink = '';
        let capsuleToRelease = null;
        let currentManagerEvent = null;

        function createAtmosphere() {
            const container = document.getElementById('atmosphere');
            for (let i = 0; i < 60; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                const size = 1 + Math.random() * 2;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.animationDelay = Math.random() * 4 + 's';
                star.style.animationDuration = (3 + Math.random() * 2) + 's';
                container.appendChild(star);
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const error = document.getElementById('loginError');
            
            btn.disabled = true;
            btn.textContent = 'Entrando...';
            error.classList.remove('show');
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            console.log('üîê Tentando login com:', email);
            
            if (!email || !password) {
                error.textContent = 'Preencha email e senha';
                error.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Entrar';
                return;
            }
            
            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login bem sucedido:', result.user.email);
            } catch (err) {
                console.error('‚ùå Erro no login:', err.code, err.message);
                error.textContent = translateError(err.code);
                error.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');
            const error = document.getElementById('registerError');
            
            btn.disabled = true;
            btn.textContent = 'Criando...';
            error.classList.remove('show');
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            console.log('üìù Tentando registrar:', email, name);
            
            if (!name || !email || !password) {
                error.textContent = 'Preencha todos os campos';
                error.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Criar Conta';
                return;
            }
            
            if (password.length < 6) {
                error.textContent = 'A senha deve ter pelo menos 6 caracteres';
                error.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Criar Conta';
                return;
            }
            
            try {
                console.log('üîÑ Criando usu√°rio no Firebase Auth...');
                const result = await auth.createUserWithEmailAndPassword(email, password);
                console.log('‚úÖ Usu√°rio criado:', result.user.uid);
                
                console.log('üîÑ Salvando dados no Database...');
                await database.ref(`operadores/${result.user.uid}`).set({
                    nome: name,
                    email: email,
                    criadoEm: new Date().toISOString()
                });
                console.log('‚úÖ Dados salvos no Database');
                
                console.log('üîÑ Atualizando displayName...');
                await result.user.updateProfile({ displayName: name });
                console.log('‚úÖ Registro completo!');
                
            } catch (err) {
                console.error('‚ùå Erro no registro:', err.code, err.message);
                error.textContent = translateError(err.code);
                error.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Criar Conta';
            }
        }

        function handleLogout() {
            if (confirm('Deseja sair da conta?')) {
                auth.signOut();
            }
        }

        function translateError(code) {
            const errors = {
                'auth/email-already-in-use': 'Este email j√° est√° em uso',
                'auth/invalid-email': 'Email inv√°lido',
                'auth/weak-password': 'A senha deve ter pelo menos 6 caracteres',
                'auth/user-not-found': 'Usu√°rio n√£o encontrado',
                'auth/wrong-password': 'Senha incorreta',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde',
                'auth/invalid-credential': 'Email ou senha incorretos'
            };
            return errors[code] || 'Ocorreu um erro. Tente novamente.';
        }

        auth.onAuthStateChanged((user) => {
            console.log('üîÑ Estado de autentica√ß√£o mudou:', user ? user.email : 'Nenhum usu√°rio');
            
            if (user) {
                currentUser = user;
                console.log('üë§ Usu√°rio logado:', user.email, user.uid);
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('app').classList.add('active');
                document.getElementById('userName').textContent = user.displayName || user.email || 'Guardi√£o';
                document.getElementById('userAvatar').textContent = (user.displayName || user.email || 'G')[0].toUpperCase();
                initializeApp();
            } else {
                currentUser = null;
                console.log('üö™ Usu√°rio deslogado');
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('app').classList.remove('active');
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtn').textContent = 'Entrar';
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('registerBtn').textContent = 'Criar Conta';
                document.getElementById('loginError').classList.remove('show');
                document.getElementById('registerError').classList.remove('show');
            }
        });

        function initializeApp() {
            const defaultDate = new Date();
            defaultDate.setFullYear(defaultDate.getFullYear() + 1);
            document.getElementById('eventDate').value = defaultDate.toISOString().split('T')[0];
            
            database.ref('eventos').orderByChild('operadorId').equalTo(currentUser.uid).on('value', (snapshot) => {
                eventsData = snapshot.val() || {};
                renderEvents();
            });
            
            database.ref('capsulas').on('value', (snapshot) => {
                const newCapsules = snapshot.val() || {};
                
                if (!firstLoad) {
                    Object.entries(newCapsules).forEach(([id, cap]) => {
                        if (!previousCapsules[id] && cap.nome && eventsData[cap.eventoId]) {
                            showNotification(cap, 'lacrou');
                        }
                    });
                }
                
                previousCapsules = JSON.parse(JSON.stringify(newCapsules));
                capsulesData = newCapsules;
                firstLoad = false;
                
                renderEvents();
                
                if (currentManagerEvent) {
                    renderCapsuleManager(currentManagerEvent);
                }
            });
        }

        async function createEvent(e) {
            e.preventDefault();
            
            const name = document.getElementById('eventName').value.trim();
            const date = document.getElementById('eventDate').value;
            
            if (!name || !date) return;
            
            const eventId = 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            try {
                await database.ref(`eventos/${eventId}`).set({
                    nome: name,
                    dataAbertura: date,
                    operadorId: currentUser.uid,
                    criadoEm: new Date().toISOString(),
                    arquivado: false
                });
                
                document.getElementById('eventName').value = '';
                showToast('‚ú® Evento criado com sucesso!');
                createConfetti();
            } catch (err) {
                showToast('Erro ao criar evento', 'error');
                console.error(err);
            }
        }

        function renderEvents() {
            const grid = document.getElementById('eventsGrid');
            const events = Object.entries(eventsData);
            
            if (events.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h3 class="empty-title">Nenhum evento ainda</h3>
                        <p class="empty-text">Crie seu primeiro evento para come√ßar a colecionar mem√≥rias!</p>
                    </div>
                `;
                return;
            }
            
            events.sort((a, b) => {
                if (a[1].arquivado !== b[1].arquivado) return a[1].arquivado ? 1 : -1;
                return new Date(b[1].criadoEm) - new Date(a[1].criadoEm);
            });
            
            grid.innerHTML = events.map(([id, event]) => {
                const capsules = Object.entries(capsulesData).filter(([, c]) => c.eventoId === id);
                const released = capsules.filter(([, c]) => c.liberada).length;
                const opened = capsules.filter(([, c]) => c.aberta).length;
                const openDate = new Date(event.dataAbertura);
                const canOpen = new Date() >= openDate;
                
                return `
                    <div class="event-card ${event.arquivado ? 'archived' : ''}">
                        <div class="event-header">
                            <div class="event-status ${event.arquivado ? 'archived' : 'active'}">
                                ${event.arquivado ? 'üìÅ Arquivado' : '‚ú® Ativo'}
                            </div>
                            <h3 class="event-name">${event.nome}</h3>
                            <div class="event-date">üìÖ Abre em ${formatDate(event.dataAbertura)}</div>
                        </div>
                        <div class="event-body">
                            <div class="event-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${capsules.length}</div>
                                    <div class="stat-label">C√°psulas</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${released}</div>
                                    <div class="stat-label">Liberadas</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${opened}</div>
                                    <div class="stat-label">Abertas</div>
                                </div>
                            </div>
                            ${capsules.length > 0 ? `
                                <div class="event-participants">
                                    ${capsules.slice(0, 5).map(([, c]) => `
                                        <div class="participant-avatar">
                                            ${c.foto ? `<img src="${c.foto}" alt="${c.nome}">` : c.nome[0]}
                                        </div>
                                    `).join('')}
                                    ${capsules.length > 5 ? `<div class="participant-avatar participant-more">+${capsules.length - 5}</div>` : ''}
                                </div>
                            ` : ''}
                            <div class="event-actions">
                                <button class="event-btn qr" onclick="showQR('${id}')">üì± QR Code</button>
                                <button class="event-btn manage" onclick="openManager('${id}')">‚öôÔ∏è Gerenciar</button>
                                ${canOpen && !event.arquivado ? `
                                    <button class="event-btn open" onclick="archiveEvent('${id}')">üéä Abrir Evento!</button>
                                ` : !event.arquivado ? `
                                    <button class="event-btn archive" onclick="archiveEvent('${id}')">üìÅ Arquivar</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showQR(eventId) {
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
            currentEventLink = `${baseUrl}jogador.html?evento=${eventId}`;
            
            document.getElementById('qrCode').innerHTML = '';
            new QRCode(document.getElementById('qrCode'), {
                text: currentEventLink,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff'
            });
            
            document.getElementById('qrLink').textContent = currentEventLink;
            document.getElementById('qrModal').classList.add('active');
        }

        function copyEventLink() {
            navigator.clipboard.writeText(currentEventLink).then(() => {
                showToast('üìã Link copiado!');
            });
        }

        function openManager(eventId) {
            currentManagerEvent = eventId;
            renderCapsuleManager(eventId);
            document.getElementById('managerModal').classList.add('active');
        }

        function renderCapsuleManager(eventId) {
            const container = document.getElementById('capsuleManager');
            const event = eventsData[eventId];
            
            if (!event) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Evento n√£o encontrado</p>';
                return;
            }
            
            const capsules = Object.entries(capsulesData)
                .filter(([, c]) => c.eventoId === eventId)
                .map(([id, c]) => ({ id, ...c }));
            
            const total = capsules.length;
            const released = capsules.filter(c => c.liberada).length;
            const opened = capsules.filter(c => c.aberta).length;
            
            container.innerHTML = `
                <div class="manager-header">
                    <h2 class="manager-title">${event.nome}</h2>
                    <p style="color: var(--text-secondary);">üìÖ Abertura: ${formatDate(event.dataAbertura)}</p>
                    <div class="manager-stats">
                        <div class="stat-item">
                            <div class="stat-value">${total}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${released}</div>
                            <div class="stat-label">Liberadas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${opened}</div>
                            <div class="stat-label">Abertas</div>
                        </div>
                    </div>
                    <div class="manager-actions">
                        <button class="btn-primary" onclick="releaseAll('${eventId}')">üîì Liberar Todas</button>
                    </div>
                </div>
                ${capsules.length === 0 ? `
                    <div class="empty-state" style="padding: 40px 0;">
                        <div class="empty-icon">üì≠</div>
                        <p class="empty-text">Nenhuma c√°psula ainda</p>
                    </div>
                ` : `
                    <div class="capsules-grid">
                        ${capsules.map(cap => `
                            <div class="capsule-card ${cap.aberta ? 'opened' : cap.liberada ? 'released' : ''}">
                                <div class="capsule-photo">
                                    ${cap.foto ? `<img src="${cap.foto}" alt="${cap.nome}">` : 'üë§'}
                                </div>
                                <div class="capsule-name">${cap.nome} ${cap.sobrenome || ''}</div>
                                <div class="capsule-status ${cap.aberta ? 'opened' : cap.liberada ? 'released' : ''}">
                                    ${cap.aberta ? '‚úÖ Aberta' : cap.liberada ? 'üîì Liberada' : 'üîí Aguardando'}
                                </div>
                                ${cap.desejos && cap.desejos.length > 0 ? `
                                    <div class="capsule-tags">
                                        ${cap.desejos.slice(0, 3).map(d => `<span class="capsule-tag">${d}</span>`).join('')}
                                    </div>
                                ` : ''}
                                ${cap.aberta ? `
                                    <button class="capsule-btn view" onclick="viewCapsule('${cap.id}')">üëÅÔ∏è Ver</button>
                                ` : `
                                    <button class="capsule-btn release" onclick="requestRelease('${cap.id}')" ${cap.liberada ? 'disabled' : ''}>
                                        ${cap.liberada ? '‚úÖ Liberada' : 'üîì Liberar'}
                                    </button>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `}
            `;
        }

        function requestRelease(capsuleId) {
            capsuleToRelease = capsuleId;
            document.getElementById('releasePassword').value = '';
            document.getElementById('passwordModal').classList.add('active');
        }

        async function confirmRelease() {
            const password = document.getElementById('releasePassword').value;
            
            try {
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
                await currentUser.reauthenticateWithCredential(credential);
                await database.ref(`capsulas/${capsuleToRelease}/liberada`).set(true);
                closeModal('passwordModal');
                showToast('üîì C√°psula liberada!');
                createConfetti();
            } catch (err) {
                showToast('Senha incorreta', 'error');
            }
        }

        async function releaseAll(eventId) {
            const password = prompt('Digite sua senha para liberar todas as c√°psulas:');
            if (!password) return;
            
            try {
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
                await currentUser.reauthenticateWithCredential(credential);
                
                const capsules = Object.entries(capsulesData).filter(([, c]) => c.eventoId === eventId && !c.liberada);
                
                for (const [id] of capsules) {
                    await database.ref(`capsulas/${id}/liberada`).set(true);
                }
                
                showToast(`üîì ${capsules.length} c√°psulas liberadas!`);
                createConfetti();
            } catch (err) {
                showToast('Senha incorreta', 'error');
            }
        }

        function viewCapsule(capsuleId) {
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
            window.open(`${baseUrl}capsula.html?id=${capsuleId}`, '_blank');
        }

        async function archiveEvent(eventId) {
            const event = eventsData[eventId];
            const action = event.arquivado ? 'desarquivar' : 'arquivar';
            
            if (!confirm(`Deseja ${action} o evento "${event.nome}"?`)) return;
            
            try {
                await database.ref(`eventos/${eventId}/arquivado`).set(!event.arquivado);
                showToast(event.arquivado ? 'üìÇ Evento reativado!' : 'üìÅ Evento arquivado!');
            } catch (err) {
                showToast('Erro ao modificar evento', 'error');
            }
        }

        function openSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchModal').classList.add('active');
            setTimeout(() => document.getElementById('searchInput').focus(), 100);
        }

        function searchCapsules() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const results = document.getElementById('searchResults');
            
            if (query.length < 2) {
                results.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Digite pelo menos 2 caracteres</p>';
                return;
            }
            
            const found = Object.entries(capsulesData)
                .filter(([, c]) => {
                    const name = `${c.nome} ${c.sobrenome || ''}`.toLowerCase();
                    return name.includes(query) && eventsData[c.eventoId];
                })
                .slice(0, 10);
            
            if (found.length === 0) {
                results.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Nenhuma c√°psula encontrada</p>';
                return;
            }
            
            results.innerHTML = found.map(([id, cap]) => {
                const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
                const link = `${baseUrl}capsula.html?id=${id}`;
                
                return `
                    <div style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 10px;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, var(--gold-primary), var(--accent-warm)); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                            ${cap.foto ? `<img src="${cap.foto}" style="width: 100%; height: 100%; object-fit: cover;">` : cap.nome[0]}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${cap.nome} ${cap.sobrenome || ''}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">${eventsData[cap.eventoId]?.nome || 'Evento'}</div>
                        </div>
                        <button class="btn-secondary" onclick="navigator.clipboard.writeText('${link}'); showToast('üìã Link copiado!');">üìã</button>
                    </div>
                `;
            }).join('');
        }

        function showNotification(capsule, action) {
            const notif = document.getElementById('notification');
            const photo = document.getElementById('notifPhoto');
            const name = document.getElementById('notifName');
            const actionEl = document.getElementById('notifAction');
            const tags = document.getElementById('notifTags');
            
            photo.innerHTML = capsule.foto ? `<img src="${capsule.foto}" alt="${capsule.nome}">` : 'üë§';
            name.textContent = `${capsule.nome} ${capsule.sobrenome || ''}`;
            actionEl.textContent = action === 'lacrou' ? '‚ú® lacrou sua c√°psula!' : 'üì¨ abriu sua c√°psula!';
            tags.innerHTML = (capsule.desejos || []).slice(0, 5).map(d => `<span class="notif-tag">${d}</span>`).join('');
            
            notif.classList.add('active');
            createConfetti();
            
            setTimeout(() => notif.classList.remove('active'), 6000);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if (id === 'managerModal') currentManagerEvent = null;
        }

        function formatDate(dateStr) {
            return new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => toast.className = 'toast', 3000);
        }

        function createConfetti() {
            const container = document.getElementById('confetti');
            container.innerHTML = '';
            const colors = ['#d4af37', '#f4d03f', '#e67e22', '#27ae60', '#fff', '#ff6b6b'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                container.appendChild(confetti);
            }
            
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
